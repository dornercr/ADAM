<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 20px; }
        .ilr-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">ADAM - Automated Detection of Authentic Material</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Search Filters</h5>
                        <div class="mb-3">
                            <label for="languageSelect" class="form-label">Language</label>
                            <select class="form-select" id="languageSelect" onchange="loadLanguageData()">
                                <option value="">Select Language</option>
                                <option value="spanish">Spanish</option>
                                <option value="english">English</option>
                                <option value="arabic">Arabic</option>
                                <option value="french">French</option>
                                <option value="turkish">Turkish</option>
                                <option value="german">German</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="topicSearch" class="form-label">Topic</label>
                            <input type="text" class="form-control" id="topicSearch" placeholder="Enter keywords">
                        </div>
                        <div class="mb-3">
                            <label for="ilrSelect" class="form-label">ILR Level</label>
                            <select class="form-select" id="ilrSelect">
                                <option value="">All Levels</option>
                            </select>
                        </div>
                        <button onclick="searchArticles()" class="btn btn-primary">Search</button>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div id="results" class="row"></div>
                <div id="pagination" class="mt-4 text-center">
                    <button id="prevPage" class="btn btn-primary" onclick="changePage(-1)">Previous</button>
                    <span id="pageInfo"></span>
                    <button id="nextPage" class="btn btn-primary" onclick="changePage(1)">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        let articles = [];
        let currentPage = 1;
        const resultsPerPage = 50;

        function loadLanguageData() {
            const language = document.getElementById('languageSelect').value;
            if (!language) return;

            fetch('available_files.json')
                .then(response => response.json())
                .then(availableFiles => {
                    const languageFiles = availableFiles[language];
                    if (!languageFiles || languageFiles.length === 0) {
                        throw new Error(`No CSV files found for language: ${language}`);
                    }

                    const promises = languageFiles.map(csvFile =>
                        Papa.parsePromise(csvFile, { download: true, header: true })
                    );

                    Promise.all(promises)
                        .then(results => {
                            articles = results.flatMap(result => result.data);
                            populateILRDropdown();
                            displayResults(articles, currentPage);
                        })
                        .catch(error => {
                            console.error("Error loading CSV files:", error);
                        });
                })
                .catch(error => {
                    console.error("Error fetching available files:", error);
                });
        }

        // Helper function to wrap Papa.parse in a Promise
        Papa.parsePromise = function(file, config) {
            return new Promise((complete, error) => {
                Papa.parse(file, {
                    ...config,
                    complete,
                    error
                });
            });
        };

        function populateILRDropdown() {
            const ilrLevels = [...new Set(articles.map(a => a.ilr_quantized))].sort();
            const ilrSelect = document.getElementById('ilrSelect');
            ilrSelect.innerHTML = '<option value="">All Levels</option>';
            ilrLevels.forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `ILR ${level}`;
                ilrSelect.appendChild(option);
            });
        }

        function searchArticles() {
            const topic = document.getElementById('topicSearch').value.toLowerCase();
            const ilr = document.getElementById('ilrSelect').value;

            const filteredArticles = articles.filter(article => {
                const titleMatch = article.title && article.title.toLowerCase().includes(topic);
                const summaryMatch = article.summary && article.summary.toLowerCase().includes(topic);
                const ilrMatch = ilr === '' || article.ilr_quantized === ilr;

                return (topic === '' || titleMatch || summaryMatch) && ilrMatch;
            });

            displayResults(filteredArticles, 1); // Reset to first page when new search is performed
        }

        function displayResults(results, page) {
            const startIndex = (page - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const paginatedResults = results.slice(startIndex, endIndex);

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            paginatedResults.forEach(article => {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'col-md-6';
                articleDiv.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <span class="badge bg-primary ilr-badge">ILR ${article.ilr_quantized || 'N/A'}</span>
                            <h5 class="card-title">${article.title || 'No Title'}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${article.language || 'Unknown Language'}</h6>
                            <p class="card-text">${article.summary || 'No summary available'}</p>
                            ${article.link ? `<a href="${article.link}" class="btn btn-sm btn-outline-primary" target="_blank">Read Full Article</a>` : ''}
                        </div>
                    </div>
                `;
                resultsDiv.appendChild(articleDiv);
            });

            updatePaginationControls(results.length, page);
        }

        function updatePaginationControls(totalResults, page) {
            const totalPages = Math.ceil(totalResults / resultsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;
            document.getElementById('prevPage').disabled = page === 1;
            document.getElementById('nextPage').disabled = page === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(articles.length / resultsPerPage);
            const newPage = currentPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayResults(articles, currentPage);
            }
        }
    </script>
</body>
</html>
